generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model exam_nodes {
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  instructor_id    String
  parent_id        String?      @db.Uuid
  kind             String
  name             String
  sort_order       Int          @default(0)
  exam_id          String?      @db.Uuid
  created_at       DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?    @default(now()) @db.Timestamptz(6)
  exams            exams?       @relation(fields: [exam_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  exam_nodes       exam_nodes?  @relation("exam_nodesToexam_nodes", fields: [parent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  other_exam_nodes exam_nodes[] @relation("exam_nodesToexam_nodes")

  @@index([exam_id], map: "idx_exam_nodes_exam_id")
  @@index([instructor_id], map: "idx_exam_nodes_instructor_id")
  @@index([kind], map: "idx_exam_nodes_kind")
  @@index([parent_id], map: "idx_exam_nodes_parent_id")
  @@index([parent_id, sort_order], map: "idx_exam_nodes_sort_order")
  @@index([instructor_id, parent_id], map: "idx_exam_nodes_instructor_parent")
  @@index([updated_at], map: "idx_exam_nodes_updated_at")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model exams {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  code          String       @unique
  description   String?
  duration      Int
  questions     Json
  status        String?      @default("draft")
  instructor_id String
  student_count Int?         @default(0)
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at    DateTime?    @default(now()) @db.Timestamptz(6)
  materials     Json?        @default("[]")
  rubric        Json?        @default("[]")
  exam_nodes    exam_nodes[]

  @@index([code], map: "idx_exams_code")
  @@index([instructor_id], map: "idx_exams_instructor_id")
  @@index([rubric], map: "idx_exams_rubric", type: Gin)
}

model grades {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id    String   @db.Uuid
  q_idx         Int
  score         Int
  comment       String?
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  stage_grading Json?
  sessions      sessions @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([session_id], map: "idx_grades_session_id")
  @@index([session_id, q_idx], map: "idx_grades_session_qidx")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model messages {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id           String   @db.Uuid
  q_idx                Int
  role                 String
  content              String
  created_at           DateTime @default(now()) @db.Timestamptz(6)
  compressed_content   String?
  compression_metadata Json?    @default("{}")
  response_id          String?  // OpenAI Responses API response ID for chaining conversations
  message_type         String?  // 질문 타입: "concept" | "calculation" | "strategy" | "other"
  tokens_used          Int?     // 토큰 사용량 (prompt + completion)
  metadata             Json?    @default("{}") // 추가 메타데이터 (토큰 상세 정보 등)
  sessions             sessions @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([session_id], map: "idx_messages_session_id")
  @@index([session_id, q_idx], map: "idx_messages_session_qidx")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model questions {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  exam_id    String   @db.Uuid
  idx        Int
  type       String
  prompt     String
  ai_context String?
  created_at DateTime @default(now()) @db.Timestamptz(6)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model sessions {
  id                      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  exam_id                 String        @db.Uuid
  student_id              String
  used_clarifications     Int           @default(0)
  created_at              DateTime      @default(now()) @db.Timestamptz(6)
  submitted_at            DateTime?     @db.Timestamptz(6)
  compressed_session_data String?
  compression_metadata    Json?         @default("{}")
  ai_summary              Json?         // AI 자동 채점 요약 평가
  grades                  grades[]
  messages                messages[]
  submissions             submissions[]

  @@index([exam_id], map: "idx_sessions_exam_id")
  @@index([student_id], map: "idx_sessions_student_id")
  @@index([exam_id, student_id], map: "idx_sessions_exam_student")
  @@index([student_id, created_at], map: "idx_sessions_student_created")
  @@index([exam_id, submitted_at], map: "idx_sessions_exam_submitted")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model submissions {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id               String   @db.Uuid
  q_idx                    Int
  answer                   String
  ai_feedback              Json?
  student_reply            String?
  created_at               DateTime @default(now()) @db.Timestamptz(6)
  updated_at               DateTime? @default(now()) @db.Timestamptz(6) // 답안 수정 시간
  answer_history           Json?    @default("[]") // 답안 수정 이력: [{ text: string, timestamp: string }]
  edit_count               Int?     @default(0) // 답안 수정 횟수
  compressed_answer_data   String?
  compressed_feedback_data String?
  compression_metadata     Json?    @default("{}")
  sessions                 sessions @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([session_id], map: "idx_submissions_session_id")
  @@index([session_id, q_idx], map: "idx_submissions_session_qidx")
}

/// Student profile information
model student_profiles {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  student_id String   @unique // Clerk user ID
  name       String   // 학생 이름
  student_number String // 학번
  school     String   // 학교명
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  @@index([student_id], map: "idx_student_profiles_student_id")
}
